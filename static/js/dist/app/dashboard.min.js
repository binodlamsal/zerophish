function deleteCampaign(e){confirm("Delete "+campaigns[e].name+"?")&&api.campaignId.delete(campaigns[e].id).success(function(e){successFlash(e.message),location.reload()})}function renderPieChart(e){return Highcharts.chart(e.elemId,{chart:{type:"pie",events:{load:function(){var a=this,t=a.renderer,i=a.series[0],n=a.plotLeft+i.center[0],o=a.plotTop+i.center[1];this.innerText=t.text(e.data[0].count,n,o).attr({"text-anchor":"middle","font-size":"16px","font-weight":"bold",fill:e.colors[0],"font-family":"Helvetica,Arial,sans-serif"}).add()},render:function(){this.innerText.attr({text:e.data[0].count})}}},title:{text:e.title},plotOptions:{pie:{innerSize:"80%",dataLabels:{enabled:!1}}},credits:{enabled:!1},tooltip:{formatter:function(){return void 0!=this.key&&'<span style="color:'+this.color+'">‚óè</span>'+this.point.name+": <b>"+this.y+"%</b><br/>"}},series:[{data:e.data,colors:e.colors}]})}function generateStatsPieCharts(e){var a=[],t={},i=0;$.each(e,function(e,a){$.each(a.stats,function(e,a){if("total"==e)return i+=a,!0;t[e]?t[e]+=a:t[e]=a})}),$.each(t,function(e,t){if(!(e in statsMapping))return!0;status_label=statsMapping[e],a.push({name:status_label,y:Math.floor(t/i*100),count:t}),a.push({name:"",y:100-Math.floor(t/i*100)});renderPieChart({elemId:e+"_chart",title:status_label,name:e,data:a,colors:[statuses[status_label].color,"#dddddd"]});a=[]});var n=0;void 0!==t.clicked&&void 0!==t.sent&&0!=t.sent&&(n=Math.round(t.clicked/t.sent*100)),renderPieChart({elemId:"phish_risk_chart",title:"Phish Risk",name:"Phish Risk",data:[{name:"Phish Risk",y:n,count:n+"%"},{name:"",y:100-n}],colors:["#f05b4f","#dddddd"]})}function generateTimelineChart(e){var a=[];$.each(e,function(e,t){var i=moment.utc(t.created_date).local();t.y=0,t.y+=t.stats.clicked,t.y=Math.floor(t.y/t.stats.total*100),a.push({campaign_id:t.id,name:t.name,x:i.valueOf(),y:t.y})}),Highcharts.chart("overview_chart",{chart:{zoomType:"x",type:"areaspline"},title:{text:"Phishing Success Overview"},xAxis:{type:"datetime",dateTimeLabelFormats:{second:"%l:%M:%S",minute:"%l:%M",hour:"%l:%M",day:"%b %d, %Y",week:"%b %d, %Y",month:"%b %Y"}},yAxis:{min:0,max:100,title:{text:"% of Success"}},tooltip:{formatter:function(){return Highcharts.dateFormat("%A, %b %d %l:%M:%S %P",new Date(this.x))+"<br>"+this.point.name+"<br>% Success: <b>"+this.y+"%</b>"}},legend:{enabled:!1},plotOptions:{series:{marker:{enabled:!0,symbol:"circle",radius:3},cursor:"pointer",point:{events:{click:function(e){window.location.href="/campaigns/"+this.campaign_id}}}}},credits:{enabled:!1},series:[{data:a,color:"#f05b4f",fillOpacity:.5}]})}function load(e){void 0===campaignTable?campaignTable=$("#campaignTable").DataTable({autoWidth:!1,columnDefs:[{orderable:!1,targets:"no-sort"},{className:"color-sent",targets:[2]},{className:"color-opened",targets:[3]},{className:"color-clicked",targets:[4]},{className:"color-success",targets:[5]},{className:"color-reported",targets:[6]}],order:[[1,"desc"]]}):(campaignTable.clear(),campaignTable.draw()),api.campaigns.summary(e).success(function(a){$("#loading").hide(),campaigns=a.campaigns,campaigns.length>0?($("#dashboard").show(),$.each(campaigns,function(e,a){var t,i=moment(a.created_date).format("MMMM Do YYYY, h:mm:ss a"),n=statuses[a.status].label||"label-default";if(moment(a.launch_date).isAfter(moment())){t="Scheduled to start: "+moment(a.launch_date).format("MMMM Do YYYY, h:mm:ss a");var o=t+"<br><br>Number of recipients: "+a.stats.total}else{t="Launch Date: "+moment(a.launch_date).format("MMMM Do YYYY, h:mm:ss a");var o=t+"<br><br>Number of recipients: "+a.stats.total+"<br><br>Emails opened: "+a.stats.opened+"<br><br>Emails clicked: "+a.stats.clicked+"<br><br>Submitted Credentials: "+a.stats.submitted_data+"<br><br>Errors : "+a.stats.error+"<br><br>Reported : "+a.stats.email_reported}campaignTable.row.add([escapeHtml(a.name)+(a.locked?' <i class="fa fa-lock" data-toggle="tooltip" data-placement="right" data-original-title="Your subscription has expired, therefore your campagains have been locked. Please contact your account manager to extend your subscription."></i>':""),a.username,i,a.stats.sent,a.stats.opened,a.stats.clicked,a.stats.submitted_data,a.stats.email_reported,'<span class="label '+n+'" data-toggle="tooltip" data-placement="right" data-html="true" title="'+o+'">'+a.status+"</span>",a.locked?"":"<div class='pull-right'><a class='btn btn-primary' href='/campaigns/"+a.id+"' data-toggle='tooltip' data-placement='left' title='View Results'>                    <i class='fa fa-bar-chart'></i>                    </a>                    <button class='btn btn-danger' onclick='deleteCampaign("+e+")' data-toggle='tooltip' data-placement='left' title='Delete Campaign'>                    <i class='fa fa-trash-o'></i>                    </button></div>"]).draw(),$('[data-toggle="tooltip"]').tooltip()}),generateStatsPieCharts(campaigns),generateTimelineChart(campaigns)):"own"===e&&$("#emptyMessage").show()}).error(function(){errorFlash("Error fetching campaigns")})}var campaigns=[],campaignTable,statuses={"Email Sent":{color:"#1abc9c",label:"label-success",icon:"fa-envelope",point:"ct-point-sent"},"Emails Sent":{color:"#1abc9c",label:"label-success",icon:"fa-envelope",point:"ct-point-sent"},"In progress":{label:"label-primary"},Queued:{label:"label-info"},Completed:{label:"label-success"},"Email Opened":{color:"#f9bf3b",label:"label-warning",icon:"fa-envelope",point:"ct-point-opened"},"Email Reported":{color:"#45d6ef",label:"label-warning",icon:"fa-bullhorne",point:"ct-point-reported"},"Clicked Link":{color:"#F39C12",label:"label-clicked",icon:"fa-mouse-pointer",point:"ct-point-clicked"},Success:{color:"#f05b4f",label:"label-danger",icon:"fa-exclamation",point:"ct-point-clicked"},Error:{color:"#6c7a89",label:"label-default",icon:"fa-times",point:"ct-point-error"},"Error Sending Email":{color:"#6c7a89",label:"label-default",icon:"fa-times",point:"ct-point-error"},"Submitted Data":{color:"#f05b4f",label:"label-danger",icon:"fa-exclamation",point:"ct-point-clicked"},Unknown:{color:"#6c7a89",label:"label-default",icon:"fa-question",point:"ct-point-error"},Sending:{color:"#428bca",label:"label-primary",icon:"fa-spinner",point:"ct-point-sending"},"Campaign Created":{label:"label-success",icon:"fa-rocket"}},statsMapping={sent:"Email Sent",opened:"Email Opened",email_reported:"Email Reported",clicked:"Clicked Link",submitted_data:"Submitted Data"};$(document).ready(function(){$("input[type=radio][name=filter]").change(function(e){load(e.target.value)}),Highcharts.setOptions({global:{useUTC:!1}}),load("own")});
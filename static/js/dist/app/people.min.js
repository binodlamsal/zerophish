function save(e){var a={};a.username=$("#username").val(),a.full_name=$("#full_name").val(),a.email=$("#email").val(),a.current_password=$("#curpassword").val(),a.new_password=$("#password").val(),a.confirm_new_password=$("#confirm_password").val(),a.api_key=$("#hidden_api_key").val(),a.id=e,a.role=parseInt($("#roles").val()),a.partner=parseInt($("#partner").val())||parseInt($("#hidden_partner").val()),a.plan_id=parseInt($("#plan_id").val())||parseInt($("#hidden_plan_id").val()),$("#expiration_date").length&&""!=$("#expiration_date").val()&&(a.expiration_date=$("#expiration_date").val()+"T23:59:59.000Z"),api.userId.post(a).success(function(e){successFlash("User updated successfully!"),dismiss(),load()}).error(function(e){modalError(e.responseJSON.message)})}function create(){var e={};if(e.username=$("#username").val(),e.full_name=$("#full_name").val(),e.email=$("#email").val(),e.password=$("#password").val(),e.role=parseInt($("#roles").val())||null,e.partner=parseInt($("#partner").val())||null,!isValidPassword(e.password))return void modalError("Password must be at least 8 chars long with at least 1 letter, 1 number and 1 special character");api.users.post(e).success(function(e){successFlash("User created successfully!"),dismiss(),load()}).error(function(e){modalError(e.responseJSON.message)})}function edit(e){if(-1!=e){var a=people[e],t=void 0!=a.subscription?moment(a.subscription.expiration_date).utc().format("YYYY-MM-DD"):null;null==t||"Administrator"==a.role?($("#expiration_date").attr("disabled","disabled"),"Administrator"==a.role?$("#plan_id").attr("disabled","disabled"):$("#plan_id").removeAttr("disabled")):($("#plan_id").removeAttr("disabled"),$("#expiration_date").removeAttr("disabled")),$("#expiration_date").length&&setTimeout(function(){$("#expiration_date").val(t)},500),"LMS User"==a.role?$(".subscription").hide():$(".subscription").show(),$("#modalSubmit").unbind("click").click(function(){save(a.id)}),api.userId.get(a.id).success(function(e){$("input[type=text], textarea").val(""),$("#username").val(e.username),$("#full_name").val(e.full_name),$("#email").val(e.email),$("#hidden_hash").val(e.hash),$("#hidden_uid").val(e.id),$("#hidden_api_key").val(e.api_key);var t=e.partner;api.roles.get().success(function(e){$("#roles").find("option").each(function(e){""!==$(this).val()&&$(this).remove()}),$.each(e,function(e,a){$("#roles").append('<option value="'+a.rid+'" >'+a.name+"</option>")})}),api.rolesByUserId.get(a.id).success(function(e){$("#roles option").prop("selected",!1),$("#roles option[value="+e.rid+"]").prop("selected",!0),3!==e.rid&&4!==e.rid?$("#partner-container").css("display","none"):$("#partner-container").css("display","")}),api.users.partners().success(function(e){$("#partner").find("option").each(function(e){""!==$(this).val()&&$(this).remove()}),$("#partner").length?$("#hidden_partner").val(""):$("#hidden_partner").val(t),$.each(e,function(e,a){var n="";n=t==a.id?'selected = "selected"':"",$("#partner").append('<option value="'+a.id+'"  '+n+">"+a.username+"</option>")})}),canManageSubscriptions?($("#hidden_plan_id").val(""),api.plans.get().success(function(e){$("#plan_id").find("option").each(function(e){""!==$(this).val()&&$(this).remove()}),$.each(e,function(e,t){var n="";n=void 0!=a.subscription&&a.subscription.plan_id==t.id?'selected = "selected"':"",$("#plan_id").append('<option value="'+t.id+'"  '+n+">"+t.name+"</option>")})})):$("#hidden_plan_id").val(null!==a.subscription?a.subscription.plan_id:""),$("#roles").change(function(){3==$(this).val()||4==$(this).val()?$("#partner-container").css("display",""):($("#partner-container").css("display","none"),$("#partner").val(""))}),$("#plan_id").change(function(){""!==$(this).val()?($("#expiration_date").removeAttr("disabled"),""==$("#expiration_date").val()&&($("#expiration_date").val(moment().format("YYYY-MM-DD")),$("#full_nameon_date").val(moment().format("YYYY-MM-DD")))):$("#expiration_date").attr("disabled","disabled")})})}else $(".row.subscription, label[for=current_password], #curpassword, label[for=confirm_password], #confirm_password").hide(),api.roles.get().success(function(e){$("#roles").find("option").each(function(e){""!==$(this).val()&&$(this).remove()}),$.each(e,function(e,a){$("#roles").append('<option value="'+a.rid+'" >'+a.name+"</option>")}),1==e.length&&$("#roles option").last().prop("selected","selected")}),api.users.partners().success(function(e){$("#partner").find("option").each(function(e){""!==$(this).val()&&$(this).remove()}),"admin"==role&&$.each(e,function(e,a){var t="";t=partner==a.id?'selected = "selected"':"",$("#partner").append('<option value="'+a.id+'"  '+t+">"+a.username+"</option>")})}),$("#roles").change(function(){3==$(this).val()||4==$(this).val()?$("#partner-container").css("display",""):($("#partner-container").css("display","none"),$("#partner").val(""))}),$("#modalSubmit").unbind("click").click(function(){create()})}function deleteUser(e){swal({title:"Are you sure?",text:"This will delete the user. This can't be undone!",type:"warning",animation:!1,showCancelButton:!0,confirmButtonText:"Delete ",confirmButtonColor:"#428bca",reverseButtons:!0,allowOutsideClick:!1,preConfirm:function(){return new Promise(function(a,t){api.userId.delete(e).success(function(e){a()}).error(function(e){t(e.responseJSON.message)})})}}).then(function(){swal("User Deleted!","This user has been deleted!","success"),$('button:contains("OK")').on("click",function(){load()})})}function dismiss(){$("#modal\\.flashes").empty(),$("#username").val(""),$("#full_name").val(""),$("#email").val(""),$("#curpassword").val(""),$("#password").val(""),$("#confirm_password").val(""),$("#partner").val(""),$("#roles").val(""),$("#modal").modal("hide"),$(".row.subscription, label[for=current_password], #curpassword, label[for=confirm_password], #confirm_password").show()}function isValidPassword(e){if(e.length<8)return!1;if(null!==e.match(/\s/))return!1;var a=e.match(/([a-zA-Z])/),t=e.match(/([0-9])/),n=e.match(/([^a-zA-Z0-9\s])/);return!(a.length<2||t.length<2||n.length<2)}function load(){void 0===peopleTable?peopleTable=$("#peopleTable").DataTable({columnDefs:[{orderable:!1,targets:"no-sort"},{targets:4,orderData:6},{targets:6,visible:!1}],order:[[4,"desc"]]}):(peopleTable.clear(),peopleTable.draw()),api.users.get().success(function(e){people=e,$("#loading").hide(),people.length>0?($("#peopleTable").show(),$.each(people,function(e,a){peopleTable.row.add(['<img style="max-height: 40px" src="'+(a.avatar_id?"/avatars/"+a.avatar_id:"/images/noavatar.png")+'"> '+a.username,a.full_name,a.email,a.role,moment(a.last_login_at).fromNow(),a.subscription?a.subscription.plan+(a.subscription.expired?" (expired)":" ✔"):"✖",moment(a.last_login_at).format("X"),"<div class='pull-right'>"+("admin"==role||"LMS User"!==a.role?"<span data-toggle='modal' data-backdrop='static' data-target='#modal'><button class='btn btn-primary' data-toggle='tooltip' data-placement='left' title='' onclick='edit("+e+")' data-original-title='Edit Member'>  <i class='fa fa-pencil'></i> </button> </span> ":"")+" <span data-backdrop='static' data-target='#modal'><button class='btn btn-danger' onclick='deleteUser("+a.id+")' data-toggle='tooltip' data-placement='left' title='Delete User'> <i class='fa fa-trash-o'></i></button></span></div>"]).draw()})):$("#emptyMessage").show()}).error(function(){$("#loading").hide(),errorFlash("Error fetching peoples")})}var people=[],peopleTable,labels={"In progress":"label-primary",Queued:"label-info",Completed:"label-success","Emails Sent":"label-success",Error:"label-danger"},campaigns=[],campaign={};$(document).ready(function(){$(".modal").on("hidden.bs.modal",function(e){$(this).removeClass("fv-modal-stack"),$("body").data("fv_open_modals",$("body").data("fv_open_modals")-1)}),$(".modal").on("shown.bs.modal",function(e){void 0===$("body").data("fv_open_modals")&&$("body").data("fv_open_modals",0),$(this).hasClass("fv-modal-stack")||($(this).addClass("fv-modal-stack"),$("body").data("fv_open_modals",$("body").data("fv_open_modals")+1),$(this).css("z-index",1040+10*$("body").data("fv_open_modals")),$(".modal-backdrop").not(".fv-modal-stack").css("z-index",1039+10*$("body").data("fv_open_modals")),$(".modal-backdrop").not("fv-modal-stack").addClass("fv-modal-stack"))}),$(document).on("hidden.bs.modal",".modal",function(){$(".modal:visible").length&&$(document.body).addClass("modal-open")}),$("#modal").on("hidden.bs.modal",function(e){dismiss()}),load(),$.fn.select2.defaults.set("width","100%"),$.fn.select2.defaults.set("dropdownParent",$("#modal_body")),$.fn.select2.defaults.set("theme","bootstrap"),$.fn.select2.defaults.set("sorter",function(e){return e.sort(function(e,a){return e.text.toLowerCase()>a.text.toLowerCase()?1:e.text.toLowerCase()<a.text.toLowerCase()?-1:0})}),$("#expiration_date").change(function(){""==$(this).val()&&$("#plan_id").val("")})});
function save(e){var a={};if(a.username=$("#username").val(),a.full_name=$("#full_name").val(),a.email=$("#email").val(),a.domain=$("#domain").val(),a.time_zone=$("#time_zone").val(),a.num_of_users=parseInt($("#num_of_users").val()),a.admin_email=$("#admin_email").val(),a.current_password=$("#curpassword").val(),a.new_password=$("#password").val(),a.confirm_new_password=$("#confirm_password").val(),a.api_key=$("#hidden_api_key").val(),a.id=e,a.role=parseInt($("#roles").val()),a.partner=parseInt($("#partner").find(":selected").val())||parseInt($("#hidden_partner").val()),a.plan_id=parseInt($("#plan_id").val())||parseInt($("#hidden_plan_id").val()),$("#expiration_date").length)if(""!=$("#expiration_date").val())a.expiration_date=$("#expiration_date").val()+"T23:59:59.000Z";else if(a.plan_id)return void modalError("Expiration date cannot be empty");$("#modalSubmit").attr("disabled",!0),$("#modalSubmit .loading").toggle(),$("#modalSubmit .text").toggle(),api.userId.post(a).success(function(e){successFlash("User updated successfully!"),dismiss(),load()}).error(function(e){modalError(e.responseJSON.message)}).always(function(){$("#modalSubmit").attr("disabled",!1),$("#modalSubmit .loading").toggle(),$("#modalSubmit .text").toggle()})}function create(){var e={};if(e.username=$("#username").val(),e.full_name=$("#full_name").val(),e.email=$("#email").val(),e.domain=$("#domain").val(),e.time_zone=$("#time_zone").val(),e.num_of_users=parseInt($("#num_of_users").val()),e.admin_email=$("#admin_email").val(),e.password=$("#password").val(),e.role=parseInt($("#roles").val())||null,e.partner=parseInt($("#partner").val())||null,!isValidPassword(e.password))return void modalError("Password must be at least 8 chars long with at least 1 letter, 1 number and 1 special character");$("#modalSubmit").attr("disabled",!0),$("#modalSubmit .loading").toggle(),$("#modalSubmit .text").toggle(),api.users.post(e).success(function(e){successFlash("User created successfully!"),dismiss(),load()}).error(function(e){modalError(e.responseJSON.message)}).always(function(){$("#modalSubmit").attr("disabled",!1),$("#modalSubmit .loading").toggle(),$("#modalSubmit .text").toggle()})}function edit(e){if($("#modal .modal-title").html("ADD USER"),$("label[for=time_zone], #time_zone + .select2-container, label[for=domain], #domain, label[for=num_of_users], #num_of_users, label[for=admin_email], #admin_email").hide(),-1!=e){$("#modal .modal-title").html("EDIT USER"),$("label[for=time_zone], #time_zone + .select2-container, label[for=domain], #domain, label[for=num_of_users], #num_of_users, label[for=admin_email], #admin_email").show();var a=people[e];"LMS User"==a.role?($("label[for=num_of_users], #num_of_users, label[for=admin_email], #admin_email, label[for=domain], #domain").hide(),$("#roles").attr("disabled",!0)):($("label[for=num_of_users], #num_of_users, label[for=admin_email], #admin_email, label[for=domain], #domain").show(),$("#roles").attr("disabled",!1));var t=void 0!=a.subscription?moment(a.subscription.expiration_date).utc().format("YYYY-MM-DD"):null;null==t||"Administrator"==a.role?($("#expiration_date").attr("disabled","disabled"),"Administrator"==a.role?$("#plan_id").attr("disabled","disabled"):$("#plan_id").removeAttr("disabled")):($("#plan_id").removeAttr("disabled"),$("#expiration_date").removeAttr("disabled")),$("#expiration_date").length&&setTimeout(function(){$("#expiration_date").val(t)},500),"LMS User"==a.role||"partner"==role&&"Child User"==a.role?$(".subscription").hide():$(".subscription").show(),$("#modalSubmit").unbind("click").click(function(){save(a.id)}),api.userId.get(a.id).success(function(e){$("input[type=text], textarea").val(""),$("#username").val(e.username),$("#full_name").val(e.full_name),$("#email").val(e.email),$("#domain").val(e.domain),$("#time_zone").val(e.time_zone).trigger("change"),$("#num_of_users").val(e.num_of_users),$("#admin_email").val(e.admin_email),$("#hidden_hash").val(e.hash),$("#hidden_uid").val(e.id),$("#hidden_api_key").val(e.api_key);var t=e.partner;api.roles.get().success(function(e){$("#roles").find("option").each(function(e){""!==$(this).val()&&$(this).remove()}),$.each(e,function(e,t){"lms_user"===t.name&&"LMS User"!==a.role||$("#roles").append('<option value="'+t.rid+'" >'+t.name+"</option>")})}),api.rolesByUserId.get(a.id).success(function(e){$("#roles").length?($("#roles option").prop("selected",!1),$("#roles option[value="+e.rid+"]").prop("selected",!0)):$("#time_zone").after('<input type="hidden" id="roles" name="roles" value="'+e.rid+'">'),3!==e.rid&&4!==e.rid&&5!==e.rid?$("#partner-container").css("display","none"):$("#partner-container").css("display","")}),$("#partner").length&&!$("#partner").hasClass("select2-hidden-accessible")?($("#partner").select2({placeholder:"Select Partner",data:"LMS User"===a.role?admins.concat(partners,customers):admins.concat(partners),allowClear:!0}),$("#partner").val(t),$("#partner").trigger("change.select2")):$("#partner").length&&($("#partner").select2("destroy").empty().select2({placeholder:"Select Partner",data:"LMS User"===a.role?admins.concat(partners,customers):admins.concat(partners),allowClear:!0}),$("#partner").val(t),$("#partner").trigger("change.select2")),$("#partner").length&&"LMS User"!=a.role?$("#hidden_partner").val(""):$("#hidden_partner").val(t),canManageSubscriptions?($("#hidden_plan_id").val(""),api.plans.get().success(function(e){$("#plan_id").find("option").each(function(e){""!==$(this).val()&&$(this).remove()}),$.each(e,function(e,t){var n="";n=void 0!=a.subscription&&a.subscription.plan_id==t.id?'selected = "selected"':"",$("#plan_id").append('<option value="'+t.id+'"  '+n+">"+t.name+"</option>")})})):$("#hidden_plan_id").val(null!==a.subscription?a.subscription.plan_id:""),$("#roles").change(function(){3==$(this).val()||4==$(this).val()||5==$(this).val()?$("#partner-container").css("display",""):($("#partner-container").css("display","none"),$("#partner").val("")),5==$(this).val()?($("label[for=num_of_users], #num_of_users, label[for=admin_email], #admin_email, label[for=domain], #domain").hide(),$("#partner").select2("destroy").empty().select2({placeholder:"Select Partner",data:admins.concat(partners,customers),allowClear:!0}),$("#partner").trigger("change.select2")):($("label[for=num_of_users], #num_of_users, label[for=admin_email], #admin_email, label[for=domain], #domain").show(),$("#partner").select2("destroy").empty().select2({placeholder:"Select Partner",data:admins.concat(partners),allowClear:!0}),$("#partner").trigger("change.select2"))}),$("#plan_id").change(function(){""!==$(this).val()?($("#expiration_date").removeAttr("disabled"),""==$("#expiration_date").val()&&($("#expiration_date").val(moment().format("YYYY-MM-DD")),$("#full_nameon_date").val(moment().format("YYYY-MM-DD")))):$("#expiration_date").attr("disabled","disabled")})})}else $(".row.subscription, label[for=current_password], #curpassword, label[for=confirm_password], #confirm_password").hide(),api.roles.get().success(function(e){$("#roles").find("option").each(function(e){""!==$(this).val()&&$(this).remove()}),$.each(e,function(e,a){"lms_user"!==a.name&&$("#roles").append('<option value="'+a.rid+'" >'+a.name+"</option>")}),1==e.length&&$("#roles option").last().prop("selected","selected")}),"admin"==role&&$("#partner").length&&!$("#partner").hasClass("select2-hidden-accessible")&&$("#partner").select2({placeholder:"Select Partner",data:admins.concat(partners),allowClear:!0}),$("#partner").hasClass("select2-hidden-accessible")&&($("#partner").val(partner),$("#partner").trigger("change.select2")),$("#roles").change(function(){3==$(this).val()||4==$(this).val()||5==$(this).val()?$("#partner-container").css("display",""):($("#partner-container").css("display","none"),$("#partner").val("")),5==$(this).val()?($("label[for=num_of_users], #num_of_users, label[for=admin_email], #admin_email, label[for=domain], #domain").hide(),$("#partner").select2("destroy").empty().select2({placeholder:"Select Partner",data:admins.concat(partners,customers),allowClear:!0}),$("#partner").trigger("change.select2")):($("label[for=num_of_users], #num_of_users, label[for=admin_email], #admin_email, label[for=domain], #domain").show(),$("#partner").select2("destroy").empty().select2({placeholder:"Select Partner",data:admins.concat(partners),allowClear:!0}),$("#partner").trigger("change.select2"))}),$("#modalSubmit").unbind("click").click(function(){create()})}function resetPassword(e){swal({title:"Want to reset password?",text:"An e-mail with password reset instructions will be sent to this user...",type:"warning",animation:!1,showCancelButton:!0,confirmButtonText:"Reset Password",confirmButtonColor:"#428bca",reverseButtons:!0,allowOutsideClick:!1,showLoaderOnConfirm:!0,preConfirm:function(){return new Promise(function(a,t){api.userId.resetPassword(e).done(function(e){a()}).fail(function(e){t(void 0!==e.responseJSON&&void 0!==e.responseJSON.message?e.responseJSON.message:"Something went wrong!")})})}}).then(function(){swal("Password reset e-mail sent."),$('button:contains("OK")').on("click",function(){})})}function deleteUser(e){swal({title:"Are you sure?",text:"This will delete the user. This can't be undone!",type:"warning",animation:!1,showCancelButton:!0,confirmButtonText:"Delete ",confirmButtonColor:"#428bca",reverseButtons:!0,allowOutsideClick:!1,preConfirm:function(){return new Promise(function(a,t){api.userId.delete(e).success(function(e){a()}).error(function(e){t(e.responseJSON.message)})})}}).then(function(){swal("User Deleted!","This user has been deleted!","success"),$('button:contains("OK")').on("click",function(){load()})})}function dismiss(){$("#modal\\.flashes").empty(),$("#username").val(""),$("#full_name").val(""),$("#email").val(""),$("#num_of_users").val(0),$("#admin_email").val(""),$("#curpassword").val(""),$("#password").val(""),$("#confirm_password").val(""),$("#partner").val(""),$("#roles").val(""),$("#modal").modal("hide"),$("#roles[type=hidden]").remove(),$("#roles").attr("disabled",!1),$(".row.subscription, label[for=current_password], #curpassword, label[for=confirm_password], #confirm_password").show()}function isValidPassword(e){if(e.length<8)return!1;if(null!==e.match(/\s/))return!1;var a=e.match(/([a-zA-Z])/),t=e.match(/([0-9])/),n=e.match(/([^a-zA-Z0-9\s])/);return null!==a&&null!==t&&null!==n}function load(){void 0===peopleTable?peopleTable=$("#peopleTable").DataTable({columnDefs:[{orderable:!1,targets:"no-sort"},{targets:4,orderData:6},{targets:6,visible:!1}],order:[[4,"desc"]]}):(peopleTable.clear(),peopleTable.draw()),void 0===admins&&(admins=[],api.users.admins().success(function(e){admins=e.map(function(e){return{id:e.id,text:e.username}})})),void 0===partners&&(partners=[],api.users.partners().success(function(e){partners=e.map(function(e){return{id:e.id,text:e.username}})})),void 0===customers&&(customers=[],api.users.customers().success(function(e){customers=e.map(function(e){return{id:e.id,text:e.username}})})),api.users.get().success(function(e){people=e,$("#loading").hide(),people.length>0?($("#peopleTable").show(),$.each(people,function(e,a){var t=a.id==partnerId,n=peopleTable.row.add(['<img style="max-height: 40px" src="'+(a.avatar_id?"/avatars/"+a.avatar_id:"/images/noavatar.png")+'"> '+a.username+(t?" [owner]":"")+(a.to_be_deleted&&"admin"==role?' <i class="fa fa-ban" style="color: red" title="Delete Requested"></i>':""),a.full_name,a.email,a.role,"0001-01-01T00:00:00Z"!==a.last_login_at?moment(a.last_login_at).fromNow():"never",a.subscription?a.subscription.plan+(a.subscription.expired?" (expired)":" ✔"):"✖",moment(a.last_login_at).format("X"),t?"":"<div class='pull-right'><span data-toggle='modal' data-backdrop='static' data-target='#modal'><button class='btn btn-primary' data-toggle='tooltip' data-placement='left' title='' onclick='edit("+e+")' data-original-title='Edit Member'>  <i class='fa fa-pencil'></i> </button> </span> <span><button class='btn btn-primary' data-toggle='tooltip' data-placement='left' title='' onclick='resetPassword("+a.id+")' data-original-title='Reset Password'>  <i class='fa fa-recycle'></i> </button> </span>  <span data-backdrop='static' data-target='#modal'><button class='btn btn-danger' onclick='deleteUser("+a.id+")' data-toggle='tooltip' data-placement='left' title='Delete User'> <i class='fa fa-trash-o'></i></button></span></div>"]);t&&$(n.node()).addClass("table-info"),n.draw()})):$("#emptyMessage").show()}).error(function(){$("#loading").hide(),errorFlash("Error fetching peoples")})}var people=[],peopleTable,admins,partners,customers,labels={"In progress":"label-primary",Queued:"label-info",Completed:"label-success","Emails Sent":"label-success",Error:"label-danger"},campaigns=[],campaign={};$(document).ready(function(){$(".modal").on("hidden.bs.modal",function(e){$(this).removeClass("fv-modal-stack"),$("body").data("fv_open_modals",$("body").data("fv_open_modals")-1)}),$(".modal").on("shown.bs.modal",function(e){void 0===$("body").data("fv_open_modals")&&$("body").data("fv_open_modals",0),$(this).hasClass("fv-modal-stack")||($(this).addClass("fv-modal-stack"),$("body").data("fv_open_modals",$("body").data("fv_open_modals")+1),$(this).css("z-index",1040+10*$("body").data("fv_open_modals")),$(".modal-backdrop").not(".fv-modal-stack").css("z-index",1039+10*$("body").data("fv_open_modals")),$(".modal-backdrop").not("fv-modal-stack").addClass("fv-modal-stack"))}),$(document).on("hidden.bs.modal",".modal",function(){$(".modal:visible").length&&$(document.body).addClass("modal-open")}),$("#modal").on("hidden.bs.modal",function(e){dismiss()}),setTimeout(function(){$("#time_zone.form-control").select2({placeholder:"Select Timezone",data:moment.tz.names()})},200),load(),$.fn.select2.defaults.set("width","100%"),$.fn.select2.defaults.set("dropdownParent",$("#modal_body")),$.fn.select2.defaults.set("theme","bootstrap"),$.fn.select2.defaults.set("sorter",function(e){return e.sort(function(e,a){return e.text.toLowerCase()>a.text.toLowerCase()?1:e.text.toLowerCase()<a.text.toLowerCase()?-1:0})})});
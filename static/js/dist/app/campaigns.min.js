function launch(){console.log($("#start_time").val()),swal({title:"Are you sure?",text:"This will schedule the campaign to be launched.",type:"question",animation:!1,showCancelButton:!0,confirmButtonText:"Launch",confirmButtonColor:"#428bca",reverseButtons:!0,allowOutsideClick:!1,showLoaderOnConfirm:!0,preConfirm:function(){return new Promise(function(e,a){groups=[],$("#users").select2("data").forEach(function(e){groups.push({id:parseInt(e.id),name:e.text})});var t=$("#send_by_date").val();return""!=t&&(t=moment(t,"MM/DD/YYYY hh:mm a").utc().format()),campaign={name:$("#name").val(),from_address:$("#from_address").val(),template:{id:parseInt($("#template").select2("data")[0].id),name:$("#template").select2("data")[0].text},url:$("#url").val(),page:{name:$("#page").select2("data")[0].text},smtp:{name:$("#profile").select2("data")[0].id},launch_date:moment($("#launch_date").val(),"MM/DD/YYYY hh:mm a").utc().format(),send_by_date:t||null,groups:groups,group_id:parseInt($("#users").select2("data")[0].id),start_time:$("#during_certain_hours_checkbox").prop("checked")?$("#start_time").val():"",end_time:$("#during_certain_hours_checkbox").prop("checked")?$("#end_time").val():"",time_zone:$("#during_certain_hours_checkbox").prop("checked")?$("#time_zone").val():"",remove_non_clickers:$("#remove_nonclickers_checkbox").prop("checked"),clickers_group_id:parseInt($("#clickers_group_id").find(":selected").val())||0,clickers_group:$("#clickers_group").val(),creator:parseInt($("#creator").find(":selected").val())||0},!$("#during_certain_hours_checkbox").prop("checked")||campaign.start_time&&campaign.end_time&&campaign.time_zone?campaign.start_time&&campaign.end_time&&moment(campaign.end_time,"h:mm A").isBefore(moment(campaign.start_time,"h:mm A"))?($("#modal\\.flashes").empty().append('<div style="text-align:center" class="alert alert-danger">            <i class="fa fa-exclamation-circle"></i> The End Time cannot be earlier than the Start Time</div>'),scrollToError(),void swal.close()):void api.campaigns.post(campaign).success(function(a){e(),campaign=a}).error(function(e){$("#modal\\.flashes").empty().append('<div style="text-align:center" class="alert alert-danger">            <i class="fa fa-exclamation-circle"></i> '+e.responseJSON.message+"</div>"),scrollToError(),swal.close()}):($("#modal\\.flashes").empty().append('<div style="text-align:center" class="alert alert-danger">            <i class="fa fa-exclamation-circle"></i> Start/End Time and/or Time Zone not specified</div>'),scrollToError(),void swal.close())})}}).then(function(){swal("Campaign Scheduled!","This campaign has been scheduled for launch!","success"),window.localStorage.setItem("NewCampaign","true"),$('button:contains("OK")').on("click",function(){window.location="/campaigns/"+campaign.id.toString()})})}function sendTestEmail(){var e={template:{name:$("#template").select2("data")[0].text},first_name:$("input[name=to_first_name]").val(),last_name:$("input[name=to_last_name]").val(),from_address:$("#from_address").val(),email:$("input[name=to_email]").val(),position:$("input[name=to_position]").val(),url:$("#url").val(),page:{name:$("#page").select2("data")[0].text},smtp:{name:$("#profile").select2("data")[0].id}};btnHtml=$("#sendTestModalSubmit").html(),$("#sendTestModalSubmit").html('<i class="fa fa-spinner fa-spin"></i> Sending'),api.send_test_email(e).success(function(e){$("#sendTestEmailModal\\.flashes").empty().append('<div style="text-align:center" class="alert alert-success">            <i class="fa fa-check-circle"></i> Email Sent!</div>'),$("#sendTestModalSubmit").html(btnHtml)}).error(function(e){$("#sendTestEmailModal\\.flashes").empty().append('<div style="text-align:center" class="alert alert-danger">            <i class="fa fa-exclamation-circle"></i> '+e.responseJSON.message+"</div>"),$("#sendTestModalSubmit").html(btnHtml)})}function dismiss(){$("#modal\\.flashes").empty(),$("#name").val(""),$("#creator").length&&$("#creator").val("").change(),$("#template").select2("data",null),$("#page").val("").change(),$("#url").val(""),$("#profile").val("").change(),$("#users").val("").change(),$("#clickers_group_id").val("").change(),$("#clickers_group").val(""),$("#time_zone").val("").change(),$("#during_certain_hours_checkbox").prop("checked")&&$("#during_certain_hours_checkbox").click(),$("#modal").modal("hide")}function dismissPreview(){$("#modalforpreview").modal("hide")}function deleteCampaign(e){swal({title:"Are you sure?",text:"This will delete the campaign. This can't be undone!",type:"warning",animation:!1,showCancelButton:!0,confirmButtonText:"Delete "+campaigns[e].name,confirmButtonColor:"#428bca",reverseButtons:!0,allowOutsideClick:!1,preConfirm:function(){return new Promise(function(a,t){api.campaignId.delete(campaigns[e].id).success(function(e){a()}).error(function(e){t(e.responseJSON.message)})})}}).then(function(){swal("Campaign Deleted!","This campaign has been deleted!","success"),$('button:contains("OK")').on("click",function(){location.reload()})})}function setupOptions(){$("#creator").length&&api.users.get().success(function(e){$("#creator.form-control").select2({placeholder:"You ("+user.username+")",allowClear:!0,data:e.map(function(e){return{id:e.id,text:e.username,role:e.role}}).filter(function(e){return e.text!==user.username&&"LMS User"!==e.role&&"Child User"!==e.role&&"Partner"!==e.role&&"Administrator"!==e.role})}),$("#creator.form-control").off("select2:select").on("select2:select",function(e){loadTemplates("public-and-uid-"+e.params.data.id),loadPages("public-and-uid-"+e.params.data.id),loadGroups("uid-"+e.params.data.id,!1)}),$("#creator.form-control").off("select2:unselect").on("select2:unselect",function(e){loadTemplates("own-and-public"),loadPages("own-and-public"),loadGroups("own",!1)})}),loadGroups("own",!0),$("#template.form-control").hasClass("select2-hidden-accessible")||loadTemplates("own-and-public"),$("#page.form-control").hasClass("select2-hidden-accessible")||loadPages("own-and-public"),api.SMTP.domains().success(function(e){if(0==e.length)return modalError("No profiles found!"),!1;var a=$.map(e,function(e){return e.id=e.name,e.text=e.name+" ("+e.host+")",e}),t=$("#profile.form-control");t.select2({placeholder:"Select a Sending Profile",data:a}).select2("val",a[0]),1===e.length&&(t.val(a[0].id),t.trigger("change.select2"))})}function loadGroups(e,a){api.groups.summary(e).success(function(e){if(a&&0==e.total)return document.location="/users?ref=campaigns",!1;var t=$.map(e.groups,function(e){return e.text=e.name,e});$("#users.form-control").empty().select2({placeholder:"Select Groups",data:t}),$("#clickers_group_id").empty().select2({placeholder:"Existing group...",data:t,allowClear:!0}).val(null).trigger("change"),$("#clickers_group_id").off("select2:select").on("select2:select",function(e){$("#clickers_group").val("")}),$("#clickers_group").off("keyup").on("keyup",function(e){$("#clickers_group_id").val(null).trigger("change")})})}function loadTemplates(e){var a={},t={},o=[];api.templates.get(e).success(function(e){if(e.length>0){var n=$.map(e,function(e){return a[e.id]=e.from_address,t[e.id]=e.default_page_id,e.text=e.name,e});o=n.map(function(e){return{id:e.id,text:e.name,category:categories.find(function(a){return a.id===e.tag})}}).reduce(function(e,a){return void 0!==a.category?void 0!==e[a.category.name]?e[a.category.name].push(a):e[a.category.name]=[a]:void 0!==e.Misc?e.Misc.push(a):e.Misc=[a],e},{}),o=Object.keys(o).map(function(e){return children=o[e],children.length>1&&children.unshift({id:1e6+children[0].category.id,text:"RANDOM ("+children[0].category.name+")"}),{text:e,children:children}})}$("#template.form-control").change(function(e){$("#from_address").val(a[e.target.value]),0!==t[e.target.value]&&void 0!==t[e.target.value]&&($("#page.form-control").val(t[e.target.value]),$("#page.form-control").trigger("change.select2")),""!==$(this).val()&&0!=$(this).val()?$("#preview-btn").prop("disabled",""):$("#preview-btn").prop("disabled","disabled")}),$("#template.form-control").empty().select2({placeholder:"Select a Template",data:o}),1===e.length&&($("#template.form-control").val(n[0].id),$("#template.form-control").trigger("change.select2"),$("#preview-btn").prop("disabled",""))})}function loadPages(e){var a=[];api.pages.get(e).success(function(e){if(e.length>0){var t=$.map(e,function(e){return e.text=e.name,e});a=t.map(function(e){return{id:e.id,text:e.name,category:categories.find(function(a){return a.id===e.tag})}}).reduce(function(e,a){return void 0!==a.category?void 0!==e[a.category.name]?e[a.category.name].push(a):e[a.category.name]=[a]:void 0!==e.Misc?e.Misc.push(a):e.Misc=[a],e},{}),a=Object.keys(a).map(function(e){return{text:e,children:a[e]}})}$("#page.form-control").empty().select2({placeholder:"Select a Landing Page",data:a}),1===e.length&&($("#page.form-control").val(t[0].id),$("#page.form-control").trigger("change.select2"))})}function edit(e){$("#modal .modal-title").html("NEW CAMPAIGN"),setupOptions()}function copy(e){$("#modal .modal-title").html("COPY CAMPAIGN"),setupOptions(),api.campaignId.get(campaigns[e].id).success(function(e){$("#name").val("Copy of "+e.name),e.template.id?($("#template").val(e.template.id.toString()),$("#template").trigger("change.select2")):$("#template").select2({placeholder:e.template.name}),e.page.id?($("#page").val(e.page.id.toString()),$("#page").trigger("change.select2")):$("#page").select2({placeholder:e.page.name}),e.smtp.id?($("#profile").val(e.smtp.name.toString()),$("#profile").trigger("change.select2")):$("#profile").select2({placeholder:e.smtp.name}),$("#url").val(e.url)}).error(function(e){$("#modal\\.flashes").empty().append('<div style="text-align:center" class="alert alert-danger">            <i class="fa fa-exclamation-circle"></i> '+e.responseJSON.message+"</div>")})}function load(e){void 0===campaignTable?campaignTable=$("#campaignTable").DataTable({autoWidth:!1,columnDefs:[{orderable:!1,targets:"no-sort"},{targets:2,orderData:5},{targets:5,visible:!1}],order:[[2,"desc"]],deferRender:!0}):(campaignTable.clear(),campaignTable.draw()),api.campaigns.summary(e).success(function(e){campaigns=e.campaigns,$("#loading").hide(),campaigns.length>0?($("#campaignTable").show(),$.each(campaigns,function(e,a){label=labels[a.status]||"label-default";var t;if(moment(a.launch_date).isAfter(moment())){t="Scheduled to start: "+moment(a.launch_date).format("MMMM Do YYYY, h:mm:ss a");var o=t+"<br><br>Number of recipients: "+a.stats.total}else{t="Launch Date: "+moment(a.launch_date).format("MMMM Do YYYY, h:mm:ss a");var o=t+"<br><br>Number of recipients: "+a.stats.total+"<br><br>Emails opened: "+a.stats.opened+"<br><br>Emails clicked: "+a.stats.clicked+"<br><br>Submitted Credentials: "+a.stats.submitted_data+"<br><br>Errors: "+a.stats.error+"<br><br>Reported: "+a.stats.email_reported+"<br><br>Phish Risk: "+Math.round(a.stats.clicked/a.stats.total*100)+"%"}campaignTable.row.add([escapeHtml(a.name)+(a.locked?' <i class="fa fa-lock" data-toggle="tooltip" data-placement="right" data-original-title="Your subscription has expired, therefore your campagains have been locked. Please contact your account manager to extend your subscription."></i>':""),a.username,moment(a.created_date).format("MMMM Do YYYY, h:mm:ss a"),'<span class="label '+label+'" data-toggle="tooltip" data-placement="right" data-html="true" title="'+o+'">'+a.status+"</span>",a.locked?"":"<div class='pull-right'><a class='btn btn-primary' href='/campaigns/"+a.id+"' data-toggle='tooltip' data-placement='left' title='View Results'>                    <i class='fa fa-bar-chart'></i>                    </a>            <span data-toggle='modal' data-backdrop='static' data-target='#modal'><button class='btn btn-primary' data-toggle='tooltip' data-placement='left' title='Copy Campaign' onclick='copy("+e+")'>                    <i class='fa fa-copy'></i>                    </button></span>                    <button class='btn btn-danger' onclick='deleteCampaign("+e+")' data-toggle='tooltip' data-placement='left' title='Delete Campaign'>                    <i class='fa fa-trash-o'></i>                    </button></div>",moment(a.created_date).format("X")]).draw(),$('[data-toggle="tooltip"]').tooltip()})):$("#emptyMessage").hide()}).error(function(){$("#loading").hide(),errorFlash("Error fetching campaigns")})}function preview(){$("#modalforpreview").modal("show"),$("#preview-btn").prop("disabled")||api.templateId.get($("#template").select2("data")[0].id).success(function(e){$("#modalforpreview .tempname").html(e.name),$("#modalforpreview .from_address").text($("#from_address").val()||e.from_address||"First Last <first.last@test.com>"),$("#modalforpreview .subject").html(e.subject),api.auth.lak.get("/api/templates/"+e.id+"/preview").success(function(a){if(!a.success||null==a.data)return void errorFlash("Could not retrieve access key for template preview");$("#modalforpreview .modal-body iframe").prop("src","/api/templates/"+e.id+"/preview?access_key="+a.data)})})}var campaignTable,categories=[],labels={"In progress":"label-primary",Queued:"label-info",Completed:"label-success","Emails Sent":"label-success",Error:"label-danger"},campaigns=[],campaign={};$(document).ready(function(){$("input[type=radio][name=filter]").change(function(e){var a=e.target.value;sessionStorage.setItem("CampaignFilter",a),load(a)}),$("#during_certain_hours_checkbox").change(function(e){$(this).prop("checked")?$("#certain_hours input, #certain_hours select").prop("disabled",""):$("#certain_hours input, #certain_hours select").prop("disabled","disabled")}),api.phishtags.get().success(function(e){categories=e}),setTimeout(function(){$("#time_zone.form-control").select2({placeholder:"Select Timezone",data:moment.tz.names()}),_timezone&&$("#time_zone").val(_timezone).trigger("change")},1e3),$("#launch_date").datetimepicker({widgetPositioning:{vertical:"bottom"},showTodayButton:!0,defaultDate:moment(),collapse:!1}),$("#send_by_date").datetimepicker({widgetPositioning:{vertical:"bottom"},showTodayButton:!0,useCurrent:!1,collapse:!1}),$("#start_time").datetimepicker({format:"LT"}),$("#end_time").datetimepicker({format:"LT"}),$(".modal").on("hidden.bs.modal",function(e){$(this).removeClass("fv-modal-stack"),$("body").data("fv_open_modals",$("body").data("fv_open_modals")-1)}),$(".modal").on("shown.bs.modal",function(e){void 0===$("body").data("fv_open_modals")&&$("body").data("fv_open_modals",0),$(this).hasClass("fv-modal-stack")||($(this).addClass("fv-modal-stack"),$("body").data("fv_open_modals",$("body").data("fv_open_modals")+1),$(this).css("z-index",1040+10*$("body").data("fv_open_modals")),$(".modal-backdrop").not(".fv-modal-stack").css("z-index",1039+10*$("body").data("fv_open_modals")),$(".modal-backdrop").not("fv-modal-stack").addClass("fv-modal-stack"))}),$(document).on("hidden.bs.modal",".modal",function(){$(".modal:visible").length&&$(document.body).addClass("modal-open")}),$("#modal").on("hidden.bs.modal",function(e){dismiss()});var e=sessionStorage.getItem("CampaignFilter")||"own";$("input[type=radio][name=filter]").val()!=e&&$("input[type=radio][name=filter]").val([e]),load(e),$.fn.select2.defaults.set("width","100%"),$.fn.select2.defaults.set("dropdownParent",$("#modal_body")),$.fn.select2.defaults.set("theme","bootstrap"),$.fn.select2.defaults.set("sorter",function(e){return e.sort(function(e,a){return e.text.toLowerCase()>a.text.toLowerCase()?1:e.text.toLowerCase()<a.text.toLowerCase()?-1:0})})});